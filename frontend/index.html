<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAN Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="jan-api-base" content="https://jan-delivery.onrender.com">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
        .header { background: var(--tg-theme-secondary-bg-color, #f8f9fa); padding: 15px; border-bottom: 1px solid #eee; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .language-selector { display: flex; gap: 5px; }
        .language-btn { padding: 5px 10px; border: 1px solid #ddd; background: #fff; border-radius: 15px; font-size: 12px; cursor: pointer; }
        .language-btn.active { background: var(--tg-theme-button-color, #0088cc); color: #fff; border-color: var(--tg-theme-button-color, #0088cc); }
        .cart-indicator { display: flex; align-items: center; gap: 5px; }
        .cart-count { background: #ff3333; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; min-width: 18px; text-align: center; }
        .nav { display: flex; padding: 10px; background: #fff; border-bottom: 1px solid #eee; }
        .nav-btn { flex: 1; padding: 12px; background: none; border: none; font-size: 14px; cursor: pointer; border-radius: 8px; }
        .nav-btn.active { background: var(--tg-theme-button-color, #0088cc); color: white; }
        .main-content { padding: 15px; }
        .page { display: none; }
        .page.active { display: block; }
        .categories-filter, .subcategories-filter { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; }
        .category-btn, .subcategory-btn { padding: 8px 15px; border: 1px solid #ddd; background: #fff; border-radius: 20px; white-space: nowrap; cursor: pointer; font-size: 13px; }
        .category-btn.active, .subcategory-btn.active { background: var(--tg-theme-button-color, #0088cc); color: white; border-color: var(--tg-theme-button-color, #0088cc); }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .menu-item { background: #fff; border-radius: 12px; padding: 15px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .menu-item h3 { font-size: 16px; margin-bottom: 5px; }
        .menu-item .category { font-size: 12px; color: #666; margin-bottom: 8px; }
        .menu-item .description { font-size: 13px; color: #888; margin-bottom: 10px; }
        .menu-item-footer { display: flex; justify-content: space-between; align-items: center; }
        .price { font-weight: 600; color: var(--tg-theme-button-color, #0088cc); }
        .weight { font-size: 11px; color: #999; }
        .add-to-cart { background: var(--tg-theme-button-color, #0088cc); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .cart-item-info h4 { font-size: 15px; margin-bottom: 5px; }
        .cart-item-category { font-size: 12px; color: #666; }
        .cart-item-price { font-weight: 600; color: var(--tg-theme-button-color, #0088cc); }
        .cart-item-controls { display: flex; align-items: center; gap: 10px; }
        .quantity-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: #fff; border-radius: 50%; cursor: pointer; }
        .quantity { min-width: 20px; text-align: center; font-weight: 600; }
        .remove-item { background: none; border: none; font-size: 16px; cursor: pointer; }
        .cart-summary { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 15px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .summary-row.total { font-weight: 600; font-size: 16px; border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px; }
        .checkout-btn { width: 100%; background: var(--tg-theme-button-color, #0088cc); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 15px; }
        .cart-empty { text-align: center; padding: 50px 20px; color: #666; }
        .cart-empty h3 { margin: 15px 0 10px; }
        .nav-to-menu { background: var(--tg-theme-button-color, #0088cc); color: white; border: none; padding: 12px 24px; border-radius: 20px; cursor: pointer; margin-top: 20px; }
        .hidden { display: none !important; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; z-index: 10000; font-size: 14px; color: white; }
        .orders-empty { text-align: center; padding: 50px 20px; color: #666; }
        .orders-empty h3 { margin: 15px 0 10px; }
        @media (max-width: 480px) {
            .menu-grid { grid-template-columns: 1fr; }
            .categories-filter, .subcategories-filter { padding-bottom: 5px; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>üçï JAN Delivery</h1>
                <div class="header-actions">
                    <div class="language-selector">
                        <button class="language-btn active" data-lang="ru">RU</button>
                        <button class="language-btn" data-lang="en">EN</button>
                        <button class="language-btn" data-lang="sr">SR</button>
                    </div>
                    <div class="cart-indicator" id="cart-indicator" style="display: none;">
                        <span class="cart-icon">üõí</span>
                        <span class="cart-count" id="cart-count">0</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <button class="nav-btn active" data-page="menu">üçΩÔ∏è –ú–µ–Ω—é</button>
            <button class="nav-btn" data-page="cart">üõí –ö–æ—Ä–∑–∏–Ω–∞</button>
            <button class="nav-btn" data-page="orders">üì¶ –ó–∞–∫–∞–∑—ã</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Menu Page -->
            <div id="menu-page" class="page active">
                <div class="categories-filter" id="categories-filter">
                    <button class="category-btn active" data-category="all">–í—Å–µ</button>
                </div>
                <div class="subcategories-filter" id="subcategories-filter" style="display:none;"></div>
                <div id="menu-items" class="menu-grid">
                    <div style="text-align: center; padding: 50px; color: #666;">
                        –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é...
                    </div>
                </div>
            </div>

            <!-- Cart Page -->
            <div id="cart-page" class="page">
                <div class="cart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
                    <button id="clear-cart" style="background: none; border: 1px solid #ddd; padding: 8px 15px; border-radius: 20px; cursor: pointer;">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <div id="cart-items" class="cart-items"></div>
                <div id="cart-summary" class="cart-summary hidden">
                    <div class="summary-row">
                        <span>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</span>
                        <span id="subtotal">0 RSD</span>
                    </div>
                    <div class="summary-row">
                        <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                        <span id="delivery-cost">200 RSD</span>
                    </div>
                    <div class="summary-row total">
                        <span>–ò—Ç–æ–≥–æ:</span>
                        <span id="total">0 RSD</span>
                    </div>
                    <button id="checkout-btn" class="checkout-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
                </div>
                <div id="cart-empty" class="cart-empty">
                    <div class="empty-icon">üõí</div>
                    <h3>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
                    <p>–î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –∏–∑ –º–µ–Ω—é</p>
                    <button class="nav-to-menu">–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–µ–Ω—é</button>
                </div>
            </div>

            <!-- Orders Page -->
            <div id="orders-page" class="page">
                <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
                <div class="orders-empty">
                    <div class="empty-icon">üì¶</div>
                    <h3>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                    <p>–°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –∏–∑ –Ω–∞—à–µ–≥–æ –º–µ–Ω—é</p>
                </div>
            </div>
        </main>
    </div>

    <script>
    console.log('=== JAN DELIVERY FAST VERSION ===');
    
    const API_BASE = 'https://jan-delivery.onrender.com';
    let menu = [];
    let categoriesData = {};
    let cart = [];
    let currentLanguage = 'ru';
    let currentCategory = 'all';
    let currentSubCategory = null;

    // –ü—Ä–æ—Å—Ç—ã–µ —É—Ç–∏–ª–∏—Ç—ã
    function log(message) {
        console.log('[JAN-FAST]', message);
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.background = type === 'error' ? '#f56565' : type === 'success' ? '#48bb78' : '#3390ec';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
    async function initApp() {
        log('–ë—ã—Å—Ç—Ä–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫ —Ç–æ–ª—å–∫–æ –Ω–∞ 100–º—Å –¥–ª—è –æ—â—É—â–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
        setTimeout(() => {
            document.getElementById('menu-items').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">‚ö° –ó–∞–≥—Ä—É–∂–∞–µ–º...</div>';
        }, 100);
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            const [menuResponse, categoriesResponse] = await Promise.all([
                fetch(`${API_BASE}/api/menu?lang=${currentLanguage}`),
                fetch(`${API_BASE}/api/menu/categories?lang=${currentLanguage}`)
            ]);
            
            if (menuResponse.ok) {
                const menuData = await menuResponse.json();
                if (menuData.success) {
                    menu = menuData.data;
                    log(`‚ö° –ú–µ–Ω—é: ${menu.length} –±–ª—é–¥`);
                }
            }
            
            if (categoriesResponse.ok) {
                const catData = await categoriesResponse.json();
                if (catData.success) {
                    categoriesData = catData.data;
                    log(`‚ö° –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: ${Object.keys(categoriesData).length}`);
                }
            }
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
            setupEvents();
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderCategories();
            renderMenu();
            
            showToast(`‚ö° ${menu.length} –±–ª—é–¥ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!`, 'success');
            
        } catch (error) {
            log('–û—à–∏–±–∫–∞: ' + error.message);
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            
            document.getElementById('menu-items').innerHTML = `
                <div style="text-align: center; padding: 30px; color: red;">
                    ‚ùå ${error.message}
                    <br><button onclick="initApp()" style="margin-top: 15px; padding: 10px 20px; background: #0088cc; color: white; border: none; border-radius: 8px;">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                </div>
            `;
        }
    }

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é
    async function loadMenu() {
        const response = await fetch(`${API_BASE}/api/menu?lang=${currentLanguage}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (!data.success || !data.data) throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç API');
        
        menu = data.data;
        return menu;
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—Å–æ–∫—Ä–∞—â–µ–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
    function setupEvents() {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => showPage(btn.dataset.page));
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('category-btn')) {
                selectCategory(e.target.dataset.category);
            } else if (e.target.classList.contains('subcategory-btn')) {
                selectSubCategory(e.target.dataset.subcategory);
            } else if (e.target.classList.contains('add-to-cart')) {
                const itemId = e.target.closest('.menu-item').dataset.itemId;
                addToCart(itemId);
            }
        });

        document.querySelectorAll('.language-btn').forEach(btn => {
            btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
        });

        // –°–æ–±—ã—Ç–∏—è –∫–æ—Ä–∑–∏–Ω—ã
        document.getElementById('clear-cart')?.addEventListener('click', clearCart);
        document.getElementById('checkout-btn')?.addEventListener('click', checkout);
        document.querySelector('.nav-to-menu')?.addEventListener('click', () => showPage('menu'));
    }

    function showPage(pageName) {
        document.querySelectorAll('.nav-btn').forEach(btn => 
            btn.classList.toggle('active', btn.dataset.page === pageName));
        
        document.querySelectorAll('.page').forEach(page => 
            page.classList.toggle('active', page.id === `${pageName}-page`));
        
        if (pageName === 'cart') {
            renderCart();
        } else if (pageName === 'orders') {
            loadOrders();
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadOrders() {
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        const userId = tgUser?.id || 'demo_user_' + Date.now();
        
        try {
            const response = await fetch(`${API_BASE}/api/orders/user/${userId}`);
            
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data.length > 0) {
                    renderOrders(result.data);
                } else {
                    showEmptyOrders();
                }
            } else {
                showEmptyOrders();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
            showEmptyOrders();
        }
    }

    function renderOrders(orders) {
        const ordersPage = document.getElementById('orders-page');
        ordersPage.innerHTML = `
            <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
            <div class="orders-list">
                ${orders.map(order => `
                    <div class="order-item" style="background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4>–ó–∞–∫–∞–∑ #${order.id}</h4>
                            <span style="padding: 4px 8px; background: ${getStatusColor(order.status)}; color: white; border-radius: 12px; font-size: 12px;">
                                ${getStatusText(order.status)}
                            </span>
                        </div>
                        <p style="color: #666; font-size: 14px; margin-bottom: 8px;">
                            üìÖ ${new Date(order.createdAt).toLocaleDateString('ru-RU')}
                        </p>
                        <p style="color: #666; font-size: 14px; margin-bottom: 8px;">
                            üìç ${order.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}
                        </p>
                        <p style="font-weight: 600; color: var(--tg-theme-button-color, #0088cc);">
                            üí∞ ${order.total || 0} RSD
                        </p>
                        <div style="margin-top: 10px; font-size: 13px; color: #999;">
                            ${order.items ? `–¢–æ–≤–∞—Ä–æ–≤: ${order.items.length}` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function showEmptyOrders() {
        const ordersPage = document.getElementById('orders-page');
        ordersPage.innerHTML = `
            <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
            <div class="orders-empty">
                <div class="empty-icon">üì¶</div>
                <h3>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                <p>–°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –∏–∑ –Ω–∞—à–µ–≥–æ –º–µ–Ω—é</p>
            </div>
        `;
    }

    function getStatusColor(status) {
        const colors = {
            'pending': '#ffa500',
            'confirmed': '#0088cc', 
            'cooking': '#ff6b35',
            'ready': '#28a745',
            'delivering': '#17a2b8',
            'delivered': '#28a745',
            'cancelled': '#dc3545'
        };
        return colors[status] || '#6c757d';
    }

    function getStatusText(status) {
        const texts = {
            'pending': '–û–∂–∏–¥–∞–µ—Ç',
            'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
            'cooking': '–ì–æ—Ç–æ–≤–∏—Ç—Å—è',
            'ready': '–ì–æ—Ç–æ–≤',
            'delivering': '–í –ø—É—Ç–∏',
            'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
        };
        return texts[status] || status;
    }

    async function switchLanguage(lang) {
        currentLanguage = lang;
        document.querySelectorAll('.language-btn').forEach(btn => 
            btn.classList.toggle('active', btn.dataset.lang === lang));
        
        showToast('–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —è–∑—ã–∫...', 'info');
        
        try {
            await loadMenu();
            const response = await fetch(`${API_BASE}/api/menu/categories?lang=${lang}`);
            if (response.ok) {
                const data = await response.json();
                if (data.success) categoriesData = data.data;
            }
            renderCategories();
            renderMenu();
            showToast('–ì–æ—Ç–æ–≤–æ!', 'success');
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞', 'error');
        }
    }

    function selectCategory(category) {
        currentCategory = category;
        currentSubCategory = null;
        
        document.querySelectorAll('.category-btn').forEach(btn => 
            btn.classList.toggle('active', btn.dataset.category === category));
        
        if (category !== 'all' && categoriesData[category]?.subCategories?.length > 0) {
            renderSubCategories(categoriesData[category].subCategories);
        } else {
            document.getElementById('subcategories-filter').style.display = 'none';
        }
        
        renderMenu();
    }

    function selectSubCategory(subCategory) {
        currentSubCategory = subCategory === 'all' ? null : subCategory;
        
        document.querySelectorAll('.subcategory-btn').forEach(btn => 
            btn.classList.toggle('active', btn.dataset.subcategory === subCategory));
        
        renderMenu();
    }

    function renderCategories() {
        const container = document.getElementById('categories-filter');
        const categories = Object.keys(categoriesData).filter(cat => cat.trim() !== '');
        
        container.innerHTML = [
            '<button class="category-btn active" data-category="all">–í—Å–µ</button>',
            ...categories.map(cat => `<button class="category-btn" data-category="${cat}">${cat}</button>`)
        ].join('');
    }

    function renderSubCategories(subCategories) {
        const container = document.getElementById('subcategories-filter');
        container.innerHTML = [
            '<button class="subcategory-btn active" data-subcategory="all">–í—Å–µ</button>',
            ...subCategories.map(sub => `<button class="subcategory-btn" data-subcategory="${sub}">${sub}</button>`)
        ].join('');
        container.style.display = 'flex';
    }

    function renderMenu() {
        const container = document.getElementById('menu-items');
        let filteredMenu = menu.filter(item => item.available);
        
        if (currentCategory !== 'all') {
            filteredMenu = filteredMenu.filter(item => item.category === currentCategory);
        }
        
        if (currentSubCategory) {
            filteredMenu = filteredMenu.filter(item => item.subCategory === currentSubCategory);
        }
        
        if (filteredMenu.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥ –Ω–µ—Ç</div>';
            return;
        }
        
        container.innerHTML = filteredMenu.map(item => `
            <div class="menu-item" data-item-id="${item.id}">
                <h3>${item.name}</h3>
                <p class="category">${item.category}${item.subCategory ? ` ‚Ä∫ ${item.subCategory}` : ''}</p>
                ${item.description ? `<p class="description">${item.description}</p>` : ''}
                <div class="menu-item-footer">
                    <span class="price">${item.price} RSD</span>
                    ${item.weight ? `<span class="weight">${item.weight}</span>` : ''}
                    <button class="add-to-cart">+</button>
                </div>
            </div>
        `).join('');
    }

    function addToCart(itemId) {
        const item = menu.find(i => i.id === itemId);
        if (!item) return;
        
        const existingItem = cart.find(c => c.id === itemId);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...item, quantity: 1 });
        }
        
        updateCartCounter();
        showToast(`${item.name} –≤ –∫–æ—Ä–∑–∏–Ω–µ`, 'success');
    }

    function updateCartCounter() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cart-count').textContent = totalItems;
        document.getElementById('cart-indicator').style.display = totalItems > 0 ? 'flex' : 'none';
    }

    function renderCart() {
        const cartContainer = document.getElementById('cart-items');
        const cartSummary = document.getElementById('cart-summary');
        const cartEmpty = document.getElementById('cart-empty');
        
        if (cart.length === 0) {
            cartContainer.innerHTML = '';
            cartSummary.classList.add('hidden');
            cartEmpty.style.display = 'block';
            return;
        }
        
        cartEmpty.style.display = 'none';
        
        cartContainer.innerHTML = cart.map(item => `
            <div class="cart-item">
                <div class="cart-item-info">
                    <h4>${item.name}</h4>
                    <p class="cart-item-category">${item.category}${item.subCategory ? ` ‚Ä∫ ${item.subCategory}` : ''}</p>
                    <p class="cart-item-price">${item.price} RSD x ${item.quantity}</p>
                </div>
                <div class="cart-item-controls">
                    <button class="quantity-btn" onclick="changeQuantity('${item.id}', -1)">-</button>
                    <span class="quantity">${item.quantity}</span>
                    <button class="quantity-btn" onclick="changeQuantity('${item.id}', 1)">+</button>
                    <button class="remove-item" onclick="removeFromCart('${item.id}')">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
        
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const deliveryCost = 200;
        const total = subtotal + deliveryCost;
        
        document.getElementById('subtotal').textContent = `${subtotal} RSD`;
        document.getElementById('total').textContent = `${total} RSD`;
        
        cartSummary.classList.remove('hidden');
    }

    function changeQuantity(itemId, change) {
        const item = cart.find(c => c.id === itemId);
        if (!item) return;
        
        item.quantity += change;
        
        if (item.quantity <= 0) {
            removeFromCart(itemId);
        } else {
            updateCartCounter();
            renderCart();
        }
    }

    function removeFromCart(itemId) {
        cart = cart.filter(c => c.id !== itemId);
        updateCartCounter();
        renderCart();
        showToast('–£–¥–∞–ª–µ–Ω–æ', 'info');
    }

    function clearCart() {
        cart = [];
        updateCartCounter();
        renderCart();
        showToast('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
    }

    async function checkout() {
        if (cart.length === 0) {
            showToast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'error');
            return;
        }
        
        showToast('–û—Ñ–æ—Ä–º–ª—è–µ–º –∑–∞–∫–∞–∑...', 'info');
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        const userId = tgUser?.id || 'demo_user_' + Date.now();
        
        const orderData = {
            userId: userId,
            items: cart,
            total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) + 200,
            address: '–ë–µ–ª–≥—Ä–∞–¥, —Ü–µ–Ω—Ç—Ä', // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É –∞–¥—Ä–µ—Å–∞ –ø–æ–∑–∂–µ
            phone: tgUser?.username || '',
            userInfo: {
                first_name: tgUser?.first_name || '',
                last_name: tgUser?.last_name || '',
                username: tgUser?.username || ''
            },
            payment_method: 'cash',
            notes: ''
        };
        
        try {
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑:', orderData);
            
            const response = await fetch(`${API_BASE}/api/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            
            const result = await response.json();
            console.log('–û—Ç–≤–µ—Ç API:', result);
            
            if (response.ok && result.success) {
                if (result.data.waitlisted) {
                    showToast('–ó–∞–∫–∞–∑ –≤ –æ—á–µ—Ä–µ–¥–∏ (–∑–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏)', 'info');
                } else {
                    showToast('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! ID: ' + result.data.id, 'success');
                }
                cart = [];
                updateCartCounter();
                renderCart();
                showPage('orders');
            } else {
                throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞:', error);
            showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }

    // ‚ö° –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫
    log('‚ö° –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫...');
    initApp();
    </script>
</body>
</html>