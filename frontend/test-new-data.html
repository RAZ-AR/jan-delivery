<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAN Delivery - Test New Data</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="jan-api-base" content="http://localhost:3001">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1><img src="assets/images/jan logo.svg" alt="JAN Delivery" class="logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span class="logo-fallback" style="display:none;">üçï</span> JAN Delivery - NEW DATA</h1>
                <div class="user-info">
                    <span id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                </div>
            </div>
            <div class="header-actions">
                <!-- Language Switcher -->
                <div class="language-selector">
                    <button class="language-btn active" data-lang="ru" title="–†—É—Å—Å–∫–∏–π">RU</button>
                    <button class="language-btn" data-lang="en" title="English">EN</button>
                    <button class="language-btn" data-lang="sr" title="–°—Ä–ø—Å–∫–∏">SR</button>
                </div>
                <div class="cart-indicator" id="cart-indicator">
                    <span class="cart-icon">üõí</span>
                    <span class="cart-count" id="cart-count">0</span>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <button class="nav-btn active" data-page="menu">üçΩÔ∏è –ú–µ–Ω—é</button>
            <button class="nav-btn" data-page="cart">üõí –ö–æ—Ä–∑–∏–Ω–∞</button>
            <button class="nav-btn" data-page="orders">üì¶ –ó–∞–∫–∞–∑—ã</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Menu Page -->
            <div id="menu-page" class="page active">
                <div class="categories-filter" id="categories-filter">
                    <button class="category-btn active" data-category="all">–í—Å–µ</button>
                </div>
                <div class="subcategories-filter" id="subcategories-filter" style="display:none;"></div>
                <div id="menu-items" class="menu-grid">
                    <div style="text-align: center; padding: 50px; color: #666;">
                        –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é –∏–∑ –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã...
                    </div>
                </div>
            </div>

            <!-- Cart Page -->
            <div id="cart-page" class="page" style="display: none;">
                <div class="cart-header">
                    <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
                    <button id="clear-cart" class="clear-btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <div id="cart-items" class="cart-items"></div>
                <div id="cart-summary" class="cart-summary hidden">
                    <div class="summary-row">
                        <span>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</span>
                        <span id="subtotal">0‚ÇΩ</span>
                    </div>
                    <div class="summary-row">
                        <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                        <span id="delivery-cost">200‚ÇΩ</span>
                    </div>
                    <div class="summary-row total">
                        <span>–ò—Ç–æ–≥–æ:</span>
                        <span id="total">0‚ÇΩ</span>
                    </div>
                    <button id="checkout-btn" class="checkout-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
                </div>
                <div id="cart-empty" class="cart-empty">
                    <div class="empty-icon">üõí</div>
                    <h3>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
                    <p>–î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –∏–∑ –º–µ–Ω—é</p>
                    <button class="nav-to-menu">–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–µ–Ω—é</button>
                </div>
            </div>

            <!-- Orders Page -->
            <div id="orders-page" class="page" style="display: none;">
                <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
                <div class="orders-empty">
                    <div class="empty-icon">üì¶</div>
                    <h3>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                    <p>–°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –∏–∑ –Ω–∞—à–µ–≥–æ –º–µ–Ω—é</p>
                </div>
            </div>
        </main>
    </div>

    <script>
    console.log('=== JAN DELIVERY NEW DATA TEST ===');
    
    const API_BASE = 'http://localhost:3001';
    let menu = [];
    let categoriesData = {};
    let cart = [];
    let currentLanguage = 'ru';
    let currentCategory = 'all';
    let currentSubCategory = null;

    // –ü—Ä–æ—Å—Ç—ã–µ —É—Ç–∏–ª–∏—Ç—ã
    function log(message) {
        console.log('[JAN-NEW]', message);
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: ${type === 'error' ? '#f56565' : type === 'success' ? '#48bb78' : '#3390ec'}; 
            color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-size: 14px;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    async function initApp() {
        log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏...');
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            await loadMenu();
            await loadCategories();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
            setupEvents();
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderCategories();
            renderMenu();
            
            log(`–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ! –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${menu.length} –±–ª—é–¥`);
            showToast(`–ù–æ–≤–æ–µ –º–µ–Ω—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ! ${menu.length} –±–ª—é–¥`, 'success');
            
        } catch (error) {
            log('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
            
            document.getElementById('menu-items').innerHTML = `
                <div style="text-align: center; padding: 50px; color: red;">
                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é: ${error.message}
                    <br><button onclick="initApp()" style="margin-top: 20px; padding: 10px 20px;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                </div>
            `;
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é
    async function loadMenu() {
        log('–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é...');
        const response = await fetch(`${API_BASE}/api/menu?lang=${currentLanguage}&_t=${Date.now()}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success || !data.data) {
            throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç API');
        }
        
        menu = data.data;
        log(`–ú–µ–Ω—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${menu.length} –±–ª—é–¥`);
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –±–ª—é–¥–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        if (menu.length > 0) {
            log('–ü—Ä–∏–º–µ—Ä –±–ª—é–¥–∞:', menu[0]);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    async function loadCategories() {
        log('–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...');
        
        try {
            const response = await fetch(`${API_BASE}/api/menu/categories?lang=${currentLanguage}&_t=${Date.now()}`);
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    categoriesData = data.data;
                    log(`–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${Object.keys(categoriesData).length}`);
                    log('–°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', Object.keys(categoriesData));
                }
            }
        } catch (error) {
            log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ' + error.message);
        }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π
    function setupEvents() {
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const page = btn.dataset.page;
                showPage(page);
            });
        });

        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('category-btn')) {
                selectCategory(e.target.dataset.category);
            } else if (e.target.classList.contains('subcategory-btn')) {
                selectSubCategory(e.target.dataset.subcategory);
            } else if (e.target.classList.contains('add-to-cart')) {
                const itemId = e.target.closest('.menu-item').dataset.itemId;
                addToCart(itemId);
            }
        });

        // –Ø–∑—ã–∫–∏
        document.querySelectorAll('.language-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchLanguage(btn.dataset.lang);
            });
        });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü
    function showPage(pageName) {
        document.querySelectorAll('.nav-btn').forEach(btn => 
            btn.classList.toggle('active', btn.dataset.page === pageName));
        
        document.querySelectorAll('.page').forEach(page => 
            page.style.display = 'none');
        
        document.getElementById(`${pageName}-page`).style.display = 'block';
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞
    async function switchLanguage(lang) {
        currentLanguage = lang;
        
        document.querySelectorAll('.language-btn').forEach(btn => 
            btn.classList.toggle('active', btn.dataset.lang === lang));
        
        showToast('–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —è–∑—ã–∫...', 'info');
        
        try {
            await loadMenu();
            await loadCategories();
            renderCategories();
            renderMenu();
            showToast(`–Ø–∑—ã–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω! ${menu.length} –±–ª—é–¥`, 'success');
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞', 'error');
        }
    }

    // –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function selectCategory(category) {
        currentCategory = category;
        currentSubCategory = null;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelectorAll('.category-btn').forEach(btn => 
            btn.classList.toggle('active', btn.dataset.category === category));
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if (category !== 'all' && categoriesData[category] && categoriesData[category].subCategories.length > 0) {
            renderSubCategories(categoriesData[category].subCategories);
        } else {
            hideSubCategories();
        }
        
        renderMenu();
    }

    // –í—ã–±–æ—Ä –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function selectSubCategory(subCategory) {
        currentSubCategory = subCategory === 'all' ? null : subCategory;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelectorAll('.subcategory-btn').forEach(btn => 
            btn.classList.toggle('active', btn.dataset.subcategory === subCategory));
        
        renderMenu();
    }

    // –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function renderCategories() {
        const container = document.getElementById('categories-filter');
        const categories = Object.keys(categoriesData).filter(cat => cat.trim() !== '');
        
        const buttons = [
            '<button class="category-btn active" data-category="all">–í—Å–µ</button>',
            ...categories.map(cat => 
                `<button class="category-btn" data-category="${cat}">${cat}</button>`)
        ];
        
        container.innerHTML = buttons.join('');
    }

    // –†–µ–Ω–¥–µ—Ä –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function renderSubCategories(subCategories) {
        const container = document.getElementById('subcategories-filter');
        
        const buttons = [
            '<button class="subcategory-btn active" data-subcategory="all">–í—Å–µ</button>',
            ...subCategories.map(sub => 
                `<button class="subcategory-btn" data-subcategory="${sub}">${sub}</button>`)
        ];
        
        container.innerHTML = buttons.join('');
        container.style.display = 'flex';
    }

    // –°–∫—Ä—ã—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function hideSubCategories() {
        document.getElementById('subcategories-filter').style.display = 'none';
    }

    // –†–µ–Ω–¥–µ—Ä –º–µ–Ω—é
    function renderMenu() {
        const container = document.getElementById('menu-items');
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        let filteredMenu = menu.filter(item => item.available);
        
        if (currentCategory !== 'all') {
            filteredMenu = filteredMenu.filter(item => item.category === currentCategory);
        }
        
        if (currentSubCategory) {
            filteredMenu = filteredMenu.filter(item => item.subCategory === currentSubCategory);
        }
        
        if (filteredMenu.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥ –Ω–µ—Ç</div>';
            return;
        }
        
        // –†–µ–Ω–¥–µ—Ä –±–ª—é–¥
        container.innerHTML = filteredMenu.map(item => `
            <div class="menu-item" data-item-id="${item.id}">
                <div class="menu-item-content">
                    <h3>${item.name}</h3>
                    <p class="category">${item.category}${item.subCategory ? ` ‚Ä∫ ${item.subCategory}` : ''}</p>
                    ${item.description ? `<p class="description">${item.description}</p>` : ''}
                    <div class="menu-item-footer">
                        <span class="price">${item.price} RSD</span>
                        ${item.weight ? `<span class="weight">${item.weight}</span>` : ''}
                        <button class="add-to-cart">+</button>
                    </div>
                </div>
            </div>
        `).join('');
        
        log(`–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ ${filteredMenu.length} –±–ª—é–¥ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${currentCategory}"`);
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
    function addToCart(itemId) {
        const item = menu.find(i => i.id === itemId);
        if (!item) return;
        
        const existingItem = cart.find(c => c.id === itemId);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...item, quantity: 1 });
        }
        
        updateCartCounter();
        showToast(`${item.name} –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É`, 'success');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
    function updateCartCounter() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cart-count').textContent = totalItems;
        document.getElementById('cart-indicator').style.display = totalItems > 0 ? 'flex' : 'none';
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    log('–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —Ç–µ—Å—Ç–æ–º –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
    initApp();
    </script>
</body>
</html>